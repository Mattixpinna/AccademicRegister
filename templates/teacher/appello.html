<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registra Presenze - Accademia d'Arte di Cagliari</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/teacher/appello.css') }}">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <header class="header">
        <div class="logo">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo Accademia d'Arte di Cagliari" height="40">
        </div>
        <nav>
            <a href="{{ url_for('teacher_bp.serve_dashboard_page') }}" class="logout-link">Home</a>
        </nav>
    </header>

    <main>
        <div class="container">
            <div class="flash-messages">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }}">
                                {{ message }}
                                <span class="close-btn" onclick="this.parentElement.style.display='none';">&times;</span>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>
            <div class="card">
                <h1>Appello per: {{ lezione.nomeMateria }}</h1>
                <p class="subtitle">Lezione del {{ lezione.data }}, ore {{ lezione.ora }}</p>

                <form id="attendance-form" action="{{ url_for('teacher_bp.salva_presenze') }}" method="POST">
                    <input type="hidden" name="idLezione" value="{{ lezione.idLezione }}">

                    <div class="student-grid">
                        <table>
                            <thead>
                                <tr>
                                    <th>Matricola</th>
                                    <th>Nome</th>
                                    <th>Cognome</th>
                                    <th>Stato</th>
                                    <th>Orario Ingresso</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for studente in studenti %}
                            <tr class="student-row {% if studente.stato == 'assente' %}is-absent{% endif %}" data-studente-id="{{ studente.matricola }}">
                                <td>{{ studente.matricola }}</td>
                                <td>{{ studente.Nome }}</td>
                                <td>{{ studente.Cognome }}</td>
                                <td>
                                    <input type="hidden" name="studente_{{ studente.matricola }}" value="{{ studente.stato }}">
                                    <button type="button" class="attendance-button {{ studente.stato }}">
                                        {{ 'Presente' if studente.stato == 'presente' else 'Assente' }}
                                    </button>
                                </td>
                                <td>
                                    <input type="hidden" id="orario-input-{{ studente.matricola }}" name="orario_{{ studente.matricola }}" value="">
                                    <button type="button" class="time-button" data-studente-id="{{ studente.matricola }}">
                                        Imposta
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem;">Nessuno studente iscritto a questa materia.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        </table>
                    </div>

                    <button type="submit" class="confirm-button" {% if not studenti %}disabled{% endif %}>
                        Conferma Presenze
                    </button>
                </form>
            </div>
        </div>
    </main>
    
    <div id="time-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Imposta Orario di Ingresso</h3>
            <p>Seleziona un orario o lascia vuoto per usare quello attuale.</p>
            <input type="time" id="modal-time-input">
            <div class="modal-actions">
                <button type="button" id="modal-save-button" class="modal-button save">Salva</button>
                <button type="button" id="modal-cancel-button" class="modal-button cancel">Annulla</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 Accademia d'Arte di Cagliari. Tutti i diritti riservati.</p>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('attendance-form');
        const modal = document.getElementById('time-modal');
        const modalTimeInput = document.getElementById('modal-time-input');
        const modalSaveButton = document.getElementById('modal-save-button');
        const modalCancelButton = document.getElementById('modal-cancel-button');
        let currentStudentId = null;

        // Gestione del click sui pulsanti Presente/Assente
        form.addEventListener('click', (event) => {
            if (event.target.classList.contains('attendance-button')) {
                toggleAttendance(event.target);
            }
            // Gestione del click sui pulsanti per impostare l'orario
            else if (event.target.classList.contains('time-button')) {
                openTimeModal(event.target);
            }
        });

        function toggleAttendance(button) {
            const row = button.closest('.student-row');
            const studentId = row.dataset.studenteId;
            const hiddenInput = form.querySelector(`input[name="studente_${studentId}"]`);

            if (button.classList.contains('presente')) {
                button.classList.remove('presente');
                button.classList.add('assente');
                button.textContent = 'Assente';
                hiddenInput.value = 'assente';
                row.classList.add('is-absent');
            } else {
                button.classList.remove('assente');
                button.classList.add('presente');
                button.textContent = 'Presente';
                hiddenInput.value = 'presente';
                row.classList.remove('is-absent');
            }
        }
        
        // --- LOGICA DEL MODALE ---
        function openTimeModal(button) {
            currentStudentId = button.dataset.studenteId;
            const hiddenTimeInput = document.getElementById(`orario-input-${currentStudentId}`);
            
            // Imposta il valore attuale dell'input del modale
            modalTimeInput.value = hiddenTimeInput.value || ''; 
            
            modal.style.display = 'flex';
        }

        function closeTimeModal() {
            modal.style.display = 'none';
            currentStudentId = null;
        }

        modalSaveButton.addEventListener('click', () => {
            if (currentStudentId) {
                const hiddenTimeInput = document.getElementById(`orario-input-${currentStudentId}`);
                const timeButton = document.querySelector(`.time-button[data-studente-id="${currentStudentId}"]`);
                
                hiddenTimeInput.value = modalTimeInput.value;
                
                // Aggiorna il testo del pulsante per dare un feedback
                if (modalTimeInput.value) {
                    timeButton.textContent = modalTimeInput.value;
                    timeButton.classList.add('is-set');
                } else {
                    timeButton.textContent = 'Imposta';
                    timeButton.classList.remove('is-set');
                }
            }
            closeTimeModal();
        });

        modalCancelButton.addEventListener('click', closeTimeModal);

        // Chiudi il modale se si clicca sull'overlay
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeTimeModal();
            }
        });
    });
    </script>
</body>
</html>