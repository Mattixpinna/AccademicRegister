<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Lezioni</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/manager/lesson_management.css') }}">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
</head>
<body>

    <header class="page-header">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo Accademia" class="logo">
        <a href="{{ url_for('manager_bp.dashboard') }}" class="logout-link">Home</a>
    </header>

    <main class="main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="card-container">
            <h2>Aggiungi Nuova Lezione</h2>
            <p class="subtitle">Compila i campi per pianificare una nuova lezione.</p>
            
            <form action="{{ url_for('manager_bp.gestione_lezioni') }}" method="post">
                <input type="hidden" name="action" value="add">
                
                <div class="form-group">
                    <label for="insegnamento">Insegnamento</label>
                    <select id="insegnamento" name="insegnamento" required>
                        <option value="">Seleziona un insegnamento...</option>
                        {% for ins in insegnamenti %}
                        <option value="{{ ins.idInsegnamento }}">{{ ins.Nome }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="anno_di_corso">Anno di Corso</label>
                    <select id="anno_di_corso" name="anno_di_corso" required>
                        <option value="">Seleziona un anno...</option>
                        <option value="1">1° Anno</option>
                        <option value="2">2° Anno</option>
                        <option value="3">3° Anno</option>
                        <option value="Breve">Breve</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="aula">Aula</label>
                    <input type="text" id="aula" name="aula" placeholder="Es. Aula 5, Laboratorio B" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="ora_inizio">Inizio Lezione</label>
                        <input type="datetime-local" id="ora_inizio" name="ora_inizio" required class="datetime-input">
                    </div>
                    <div class="form-group half-width">
                        <label for="ora_fine">Fine Lezione</label>
                        <input type="datetime-local" id="ora_fine" name="ora_fine" required class="datetime-input">
                    </div>
                </div>

                <button type="submit" class="submit-button">Aggiungi Lezione</button>
            </form>
        </div>

        <div class="card-container">
            <h2>Calendario Lezioni</h2>
            <div id='calendar'></div>
        </div>
    </main>

    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalTitle"></h3>
            <p><strong>Anno di Corso:</strong> <span id="modalCourseYear"></span></p>
            <p><strong>Inizio:</strong> <span id="modalStart"></span></p>
            <p><strong>Fine:</strong> <span id="modalEnd"></span></p>
            <p><strong>Aula:</strong> <span id="modalAula"></span></p>
            <form id="deleteForm" action="{{ url_for('manager_bp.gestione_lezioni') }}" method="post">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" id="idLezioneDaEliminare" name="idLezioneDaEliminare">
                <button type="submit" class="delete-button">Elimina Lezione</button>
            </form>
        </div>
    </div>

    <footer class="footer">
        <p>© 2025 Accademia d'Arte di Cagliari. Tutti i diritti riservati.</p>
    </footer>

    <script>
        // Lo script rimane invariato
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var modal = document.getElementById('eventModal');
            var closeButton = document.querySelector('.close-button');
    
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: 'it',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                slotMinTime: '08:00:00',
                slotMaxTime: '20:00:00',
                allDaySlot: false,
                events: '/manager/lezioni/api',
                eventClick: function(info) {
                    const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                    const startDate = info.event.start.toLocaleString('it-IT', options);
                    const endDate = info.event.end.toLocaleString('it-IT', options);
    
                    document.getElementById('modalTitle').innerText = info.event.title;
                    document.getElementById('modalStart').innerText = startDate;
                    document.getElementById('modalEnd').innerText = endDate;
                    document.getElementById('modalAula').innerText = info.event.extendedProps.extended_aula;
                    document.getElementById('modalCourseYear').innerText = info.event.extendedProps.course_year || 'Non specificato';
                    document.getElementById('idLezioneDaEliminare').value = info.event.id;
    
                    modal.style.display = 'block';
                }
            });
    
            closeButton.onclick = function() { modal.style.display = 'none'; }
            window.onclick = function(event) { if (event.target == modal) { modal.style.display = 'none'; } }
    
            calendar.render();
        });
    </script>
</body>
</html>