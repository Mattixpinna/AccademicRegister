<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Registro Accademico</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
</head>
<body class="login-body-layout">
    <header class="login-header">
        <div class="login-logo-container">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo Accademia d'Arte di Cagliari" class="login-academy-logo">
        </div>
    </header>

    <main class="login-main-content">
        <div class="login-form-container">
            <h2 class="login-heading">Accedi al tuo account</h2>

            <form id="login-form" class="login-form" method="POST" novalidate>

                {{ form.hidden_tag() }} <div class="form-group">
                    {{ form.email.label(class="form-label") }}
                    {{ form.email(class="form-input", placeholder="Inserisci la tua email", required=True) }}
                </div>
                <div class="form-group">
                    {{ form.password.label(class="form-label") }}
                    {{ form.password(class="form-input", placeholder="Inserisci la tua password", required=True) }}
                </div>
                <button type="submit" class="login-button">Accedi</button>
            </form>
            
            <div id="error-container" class="error-container"></div>
            <div id="message-container"></div>
        </div>
    </main>

    <footer class="login-footer">
        <p>&copy; 2025 Accademia d'Arte di Cagliari. Tutti i diritti riservati.</p>
    </footer>

    <script>
        const loginForm = document.getElementById('login-form');
        // Uniamo i due contenitori in uno solo per semplicità
        const messageContainer = document.getElementById('message-container');

        loginForm.addEventListener('submit', function (event) {
            event.preventDefault(); // Impedisce l'invio tradizionale del form
            
            // Pulisce i messaggi precedenti
            messageContainer.innerHTML = '';

            const formData = new FormData(loginForm);

            fetch("{{ url_for('auth_bp.handle_login_api') }}", {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200 && body.redirect_url) {
                    // Crea il div del messaggio, assegna la classe CSS e il testo
                    messageContainer.innerHTML = `<div class="response-message message-success">${body.message}</div>`;
                    
                    // Reindirizza dopo un breve ritardo
                    setTimeout(() => { window.location.href = body.redirect_url; }, 1000);

                } else {
                    // Costruisce il messaggio di errore
                    let errorMessage = body.error || body.message || 'Si è verificato un errore.';
                    if (body.details) {
                        errorMessage += '<ul>';
                        for (const field in body.details) {
                            // Mostra il primo errore per ogni campo
                            errorMessage += `<li>${body.details[field][0]}</li>`;
                        }
                        errorMessage += '</ul>';
                    }
                    
                    // Crea il div del messaggio, assegna la classe CSS e l'HTML dell'errore
                    messageContainer.innerHTML = `<div class="response-message message-error">${errorMessage}</div>`;
                }
            })
            .catch((error) => {
                console.error('Errore:', error);
                // Messaggio di errore generico per problemi di rete
                messageContainer.innerHTML = `<div class="response-message message-error">Impossibile contattare il server.</div>`;
            });
        });
    </script>
</body>
</html>